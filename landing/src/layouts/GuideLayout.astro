---
import BaseLayout from './BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import RelatedGuides from '../components/RelatedGuides.astro';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    publishDate: Date;
    updatedDate?: Date;
    author: string;
    brand?: string;
    image?: string;
    readingTime?: number;
  };
  headings?: Array<{depth: number; slug: string; text: string}>;
}

const { frontmatter, headings = [] } = Astro.props;

const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Get Table of Contents from headings
const toc = headings.filter(h => h.depth === 2 || h.depth === 3);

// Brand colors
const brandColors: Record<string, string> = {
  nike: '#F97316',
  adidas: '#3B82F6',
  puma: '#10B981',
  umbro: '#8B5CF6',
  default: '#FBBF24'
};

const brandColor = brandColors[frontmatter.brand?.toLowerCase() || 'default'] || brandColors.default;

// Get current page slug for breadcrumb
const currentSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || '';
const breadcrumbLabel = frontmatter.brand || frontmatter.title.split(' ').slice(0, 3).join(' ');

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Guides', href: '/guides' },
  { label: breadcrumbLabel }
];

// Article Schema for SEO
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": frontmatter.title,
  "description": frontmatter.description,
  "author": {
    "@type": "Organization",
    "name": "KitTicker"
  },
  "publisher": {
    "@type": "Organization",
    "name": "KitTicker",
    "logo": {
      "@type": "ImageObject",
      "url": "https://kitticker.com/logo.png"
    }
  },
  "datePublished": frontmatter.publishDate,
  "dateModified": frontmatter.updatedDate || frontmatter.publishDate,
  "image": frontmatter.image || "https://kitticker.com/og-image.png"
};
---

<BaseLayout 
  title={`${frontmatter.title} | KitTicker`}
  description={frontmatter.description}
  canonicalUrl={`https://kitticker.com/guides/${Astro.url.pathname.split('/').pop()}`}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  
  <article class="min-h-screen bg-[#0a0a0a]">
    <!-- Header with Breadcrumb -->
    <header class="sticky top-0 z-50 bg-[#0a0a0a]/95 backdrop-blur-lg border-b border-white/10 lg:relative lg:bg-transparent lg:backdrop-blur-none lg:border-0">
      <div class="max-w-7xl mx-auto px-4 py-3 lg:py-6">
        <Breadcrumb items={breadcrumbItems} />
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pb-16 lg:flex lg:gap-8">
      <!-- Sidebar ToC (Desktop) -->
      <aside class="hidden lg:block lg:w-64 flex-shrink-0">
        <div class="sticky top-24">
          <nav class="p-4 bg-zinc-900/50 rounded-xl border border-white/5">
            <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">On This Page</h3>
            <ul class="space-y-2">
              {toc.map((heading) => (
                <li>
                  <a 
                    href={`#${heading.slug}`}
                    class={`block text-sm transition-colors hover:text-white ${heading.depth === 3 ? 'pl-4 text-zinc-500' : 'text-zinc-400 font-medium'}`}
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
          
          <!-- Quick CTA -->
          <div class="mt-6 p-4 bg-gradient-to-br from-amber-500/10 to-transparent rounded-xl border border-amber-500/20">
            <p class="text-sm text-zinc-400 mb-3">Need to verify a code?</p>
            <a href="/codes" class="inline-flex items-center gap-2 text-sm font-semibold text-amber-400 hover:text-amber-300">
              Browse Database
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 min-w-0">
        <!-- Title Section -->
        <div class="mb-8 lg:mb-12">
          {frontmatter.brand && (
            <span 
              class="inline-block px-3 py-1 text-xs font-semibold rounded-full mb-4"
              style={`background: ${brandColor}20; color: ${brandColor};`}
            >
              {frontmatter.brand}
            </span>
          )}
          
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
            {frontmatter.title}
          </h1>
          
          <p class="text-lg text-zinc-400 mb-6">
            {frontmatter.description}
          </p>
          
          <div class="flex flex-wrap items-center gap-3 text-sm text-zinc-500">
            <span>By {frontmatter.author}</span>
            <span class="text-zinc-700">•</span>
            <time datetime={frontmatter.publishDate.toISOString()}>
              {formatDate(frontmatter.publishDate)}
            </time>
            {frontmatter.readingTime && (
              <>
                <span class="text-zinc-700">•</span>
                <span>{frontmatter.readingTime} min read</span>
              </>
            )}
          </div>
        </div>

        <!-- Mobile ToC (Collapsible) -->
        <details class="lg:hidden mb-8 bg-zinc-900/50 rounded-xl border border-white/5">
          <summary class="px-4 py-3 text-sm font-semibold text-zinc-300 cursor-pointer flex items-center justify-between">
            <span>Table of Contents</span>
            <svg class="w-4 h-4 text-zinc-500 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <nav class="px-4 pb-4">
            <ul class="space-y-2">
              {toc.map((heading) => (
                <li>
                  <a 
                    href={`#${heading.slug}`}
                    class={`block py-1 text-sm transition-colors hover:text-white ${heading.depth === 3 ? 'pl-4 text-zinc-500' : 'text-zinc-400'}`}
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </details>

        <!-- Article Content -->
        <div class="guide-content prose prose-invert prose-lg max-w-none
          prose-headings:text-white prose-headings:font-bold prose-headings:scroll-mt-20
          prose-h2:text-2xl prose-h2:sm:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:pb-3 prose-h2:border-b prose-h2:border-white/10
          prose-h3:text-xl prose-h3:sm:text-2xl prose-h3:mt-8 prose-h3:mb-4
          prose-p:text-zinc-300 prose-p:leading-relaxed prose-p:text-base
          prose-a:text-amber-400 prose-a:no-underline hover:prose-a:underline
          prose-strong:text-white
          prose-code:text-amber-400 prose-code:bg-zinc-800 prose-code:px-2 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
          prose-pre:bg-zinc-900 prose-pre:border prose-pre:border-white/10 prose-pre:text-base
          prose-ul:text-zinc-300 prose-ol:text-zinc-300
          prose-li:marker:text-amber-400
          prose-blockquote:border-amber-400 prose-blockquote:text-zinc-400
          prose-img:rounded-xl prose-img:border prose-img:border-white/10
          prose-table:text-zinc-300 prose-table:text-sm
          prose-th:text-white prose-th:bg-zinc-800/50 prose-th:py-3 prose-th:px-4
          prose-td:border-zinc-700/50 prose-td:py-3 prose-td:px-4
        ">
          <slot />
        </div>

        <!-- Related Guides -->
        <RelatedGuides currentGuideSlug={currentSlug} currentBrand={frontmatter.brand} />

        <!-- Bottom CTA -->
        <div class="mt-12 p-6 sm:p-8 bg-gradient-to-r from-amber-500/10 to-transparent rounded-2xl border border-amber-500/20">
          <h3 class="text-xl sm:text-2xl font-bold text-white mb-3">
            Ready to verify a product code?
          </h3>
          <p class="text-zinc-400 mb-6 text-base">
            Use our database to instantly check if a product code matches an authentic kit.
          </p>
          <div class="flex flex-col sm:flex-row gap-3">
            <a 
              href="/codes"
              class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-400 to-amber-600 text-black font-semibold rounded-full hover:shadow-lg hover:shadow-amber-500/25 transition-all text-center"
            >
              Browse Code Database
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a 
              href="/guides"
              class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-white/20 text-white font-semibold rounded-full hover:bg-white/5 transition-all text-center"
            >
              More Guides
            </a>
          </div>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* Mobile ToC arrow rotation */
  details[open] summary svg {
    transform: rotate(180deg);
  }
  
  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }
  
  /* Touch-friendly spacing for mobile */
  @media (max-width: 640px) {
    .guide-content :global(h2),
    .guide-content :global(h3) {
      scroll-margin-top: 5rem;
    }
    
    .guide-content :global(a) {
      padding: 0.25rem 0;
    }
  }
</style>
