---
interface Props {
  variant?: 'full' | 'compact';
}

const { variant = 'full' } = Astro.props;
---

<div class={`code-checker ${variant === 'compact' ? 'p-4' : 'p-6 sm:p-8'} bg-gradient-to-br from-zinc-900 to-zinc-900/50 rounded-2xl border border-white/10`}>
  <div class="flex items-center gap-3 mb-4">
    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
      <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
    </div>
    <div>
      <h3 class="font-semibold text-white text-lg">Multi-Signal Authenticator</h3>
      <p class="text-sm text-zinc-500">Weighted confidence scoring with explainable evidence</p>
    </div>
  </div>

  <div class="space-y-4">
    <!-- Brand Selector -->
    <div class="flex flex-wrap gap-2">
      <button class="brand-btn px-3 py-2 rounded-lg border border-white/10 bg-zinc-800/50 text-zinc-400 text-sm font-medium transition-all hover:border-white/20 data-[active=true]:border-amber-500/50 data-[active=true]:bg-amber-500/10 data-[active=true]:text-amber-400" data-brand="all" data-active="true">
        All Brands
      </button>
      <button class="brand-btn px-3 py-2 rounded-lg border border-white/10 bg-zinc-800/50 text-zinc-400 text-sm font-medium transition-all hover:border-white/20 data-[active=true]:border-orange-500/50 data-[active=true]:bg-orange-500/10 data-[active=true]:text-orange-400" data-brand="Nike">
        Nike
      </button>
      <button class="brand-btn px-3 py-2 rounded-lg border border-white/10 bg-zinc-800/50 text-zinc-400 text-sm font-medium transition-all hover:border-white/20 data-[active=true]:border-blue-500/50 data-[active=true]:bg-blue-500/10 data-[active=true]:text-blue-400" data-brand="Adidas">
        Adidas
      </button>
      <button class="brand-btn px-3 py-2 rounded-lg border border-white/10 bg-zinc-800/50 text-zinc-400 text-sm font-medium transition-all hover:border-white/20 data-[active=true]:border-green-500/50 data-[active=true]:bg-green-500/10 data-[active=true]:text-green-400" data-brand="Puma">
        Puma
      </button>
      <button class="brand-btn px-3 py-2 rounded-lg border border-white/10 bg-zinc-800/50 text-zinc-400 text-sm font-medium transition-all hover:border-white/20 data-[active=true]:border-purple-500/50 data-[active=true]:bg-purple-500/10 data-[active=true]:text-purple-400" data-brand="Umbro">
        Umbro
      </button>
    </div>

    <!-- Input -->
    <div class="relative">
      <input 
        type="text" 
        id="product-code-input"
        placeholder="Enter product code (e.g., CZ3984-100)"
        class="w-full px-4 py-3 bg-zinc-800/50 border border-white/10 rounded-xl text-white placeholder-zinc-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/25 transition-all font-mono text-lg"
        autocomplete="off"
        spellcheck="false"
      />
      <button 
        id="check-code-btn"
        class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-amber-500 hover:bg-amber-400 text-black font-semibold rounded-lg transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Verify
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden">
      <div class="flex items-center gap-3 text-zinc-400 p-4">
        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Running multi-signal verification...</span>
      </div>
    </div>

    <!-- Result Area -->
    <div id="code-result" class="hidden">
      <div id="result-content" class="p-4 rounded-xl border"></div>
    </div>

    <!-- Quick Examples -->
    <div class="flex flex-wrap gap-2">
      <span class="text-xs text-zinc-500">Try:</span>
      <button class="example-code px-2 py-1 text-xs font-mono bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded transition-colors" data-code="CZ3984-100">Nike</button>
      <button class="example-code px-2 py-1 text-xs font-mono bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded transition-colors" data-code="IS7462">Adidas</button>
      <button class="example-code px-2 py-1 text-xs font-mono bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded transition-colors" data-code="736251-01">Puma</button>
      <button class="example-code px-2 py-1 text-xs font-mono bg-zinc-800 hover:bg-zinc-700 text-red-400 rounded transition-colors border border-red-500/30" data-code="CW1526">⚠️ Fake</button>
      <button class="example-code px-2 py-1 text-xs font-mono bg-zinc-800 hover:bg-zinc-700 text-yellow-400 rounded transition-colors" data-code="UNKNOWN123">Unknown</button>
    </div>

    <!-- Recently Checked -->
    <div id="recently-checked" class="hidden pt-4 border-t border-white/5">
      <p class="text-xs text-zinc-500 mb-2">Recently verified kits:</p>
      <div id="recent-codes" class="flex flex-wrap gap-2"></div>
    </div>
  </div>
</div>

<script>
  // ============================================
  // Import from centralized verifier module
  // ============================================
  import {
    type VerdictType,
    type AuthenticationSignal,
    supabase,
    verifyProductCode,
  } from '../lib/verifier';

  // ============================================
  // DOM Elements
  // ============================================

  const input = document.getElementById('product-code-input') as HTMLInputElement;
  const checkBtn = document.getElementById('check-code-btn') as HTMLButtonElement;
  const resultArea = document.getElementById('code-result');
  const resultContent = document.getElementById('result-content');
  const loadingState = document.getElementById('loading-state');
  const exampleBtns = document.querySelectorAll('.example-code');
  const brandBtns = document.querySelectorAll('.brand-btn');
  const recentlyChecked = document.getElementById('recently-checked');
  const recentCodes = document.getElementById('recent-codes');

  let selectedBrand = 'all';

  // ============================================
  // Brand Selection
  // ============================================

  brandBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      brandBtns.forEach(b => b.setAttribute('data-active', 'false'));
      btn.setAttribute('data-active', 'true');
      selectedBrand = btn.getAttribute('data-brand') || 'all';
      
      const placeholders: Record<string, string> = {
        'all': 'Enter product code (e.g., CZ3984-100)',
        'Nike': 'Nike code (e.g., CZ3984-100)',
        'Adidas': 'Adidas code (e.g., IS7462)',
        'Puma': 'Puma code (e.g., 736251-01)',
        'Umbro': 'Umbro code (e.g., 96281-U)',
      };
      input.placeholder = placeholders[selectedBrand] || placeholders['all'];
      
      // Clear previous results when brand changes
      if (resultArea && resultContent) {
        resultArea.classList.add('hidden');
        resultContent.innerHTML = '';
      }
      // Clear input when switching brands for cleaner UX
      input.value = '';
    });
  });

  // ============================================
  // UI Helper Functions
  // ============================================

  function getVerdictColors(verdict: VerdictType) {
    const colors = {
      highly_likely_authentic: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/30', text: 'text-emerald-400', icon: '✓', glow: 'verdict-glow-authentic', gauge: 'confidence-authentic' },
      probably_authentic: { bg: 'bg-green-500/10', border: 'border-green-500/30', text: 'text-green-400', icon: '✓', glow: 'verdict-glow-authentic', gauge: 'confidence-authentic' },
      uncertain: { bg: 'bg-yellow-500/10', border: 'border-yellow-500/30', text: 'text-yellow-400', icon: '?', glow: 'verdict-glow-warning', gauge: 'confidence-warning' },
      suspicious: { bg: 'bg-orange-500/10', border: 'border-orange-500/30', text: 'text-orange-400', icon: '⚠', glow: 'verdict-glow-warning', gauge: 'confidence-warning' },
      likely_fake: { bg: 'bg-red-500/10', border: 'border-red-500/30', text: 'text-red-400', icon: '✗', glow: 'verdict-glow-fake', gauge: 'confidence-fake' },
      blacklisted: { bg: 'bg-red-600/20', border: 'border-red-600/50', text: 'text-red-500', icon: '⛔', glow: 'verdict-glow-fake', gauge: 'confidence-fake' },
    };
    return colors[verdict];
  }

  function getVerdictLabel(verdict: VerdictType): string {
    const labels = {
      highly_likely_authentic: 'Highly Likely Authentic',
      probably_authentic: 'Probably Authentic',
      uncertain: 'Uncertain',
      suspicious: 'Suspicious',
      likely_fake: 'Likely Fake',
      blacklisted: 'Known Counterfeit',
    };
    return labels[verdict];
  }

  function renderSignals(signals: AuthenticationSignal[]): string {
    return signals.map(signal => {
      const iconClass = signal.value === 'pass' ? 'text-emerald-400' : 
                        signal.value === 'fail' ? 'text-red-400' : 
                        signal.value === 'warning' ? 'text-yellow-400' : 'text-zinc-500';
      return `
        <div class="flex items-start gap-2 py-1.5 border-b border-white/5 last:border-0">
          <span class="${iconClass} text-sm font-mono">${signal.value === 'pass' ? '✓' : signal.value === 'fail' ? '✗' : signal.value === 'warning' ? '⚠' : '?'}</span>
          <div class="flex-1">
            <span class="text-xs text-zinc-500">${signal.category}</span>
            <p class="text-sm text-zinc-300">${signal.evidence}</p>
          </div>
          <span class="text-xs text-zinc-600">${Math.round(signal.weight * signal.confidence)}pts</span>
        </div>
      `;
    }).join('');
  }

  // ============================================
  // Main Verification Flow
  // ============================================

  async function showResult(code: string) {
    if (!resultArea || !resultContent || !loadingState) return;
    
    if (!code.trim()) {
      resultArea.classList.remove('hidden');
      resultContent.innerHTML = `
        <div class="flex items-center gap-3 text-zinc-400">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Enter a product code to verify</span>
        </div>
      `;
      resultContent.className = 'p-4 rounded-xl border border-zinc-700 bg-zinc-800/30';
      return;
    }
    
    // Show loading
    resultArea.classList.add('hidden');
    loadingState.classList.remove('hidden');
    checkBtn.disabled = true;
    
    try {
      // Use centralized verifier function
      const result = await verifyProductCode(code, { 
        brandFilter: selectedBrand !== 'all' ? selectedBrand : undefined 
      });
      const colors = getVerdictColors(result.verdict);
      
      loadingState.classList.add('hidden');
      resultArea.classList.remove('hidden');
      checkBtn.disabled = false;
      
      resultContent.innerHTML = `
        <div class="space-y-4 animate-bounce-in">
          <!-- Header with Confidence Gauge -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl ${colors.bg} flex items-center justify-center animate-code-found">
                <span class="${colors.text} text-2xl">${colors.icon}</span>
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 text-xs font-semibold ${colors.bg} ${colors.text} rounded">${getVerdictLabel(result.verdict)}</span>
                </div>
                <p class="text-sm text-zinc-400 mt-1">${result.recommendation}</p>
              </div>
            </div>
            <div class="text-right w-24">
              <div class="text-3xl font-bold ${colors.text}">${result.confidenceScore}%</div>
              <div class="confidence-gauge mt-1">
                <div class="confidence-gauge-fill ${colors.gauge}" style="width: ${result.confidenceScore}%"></div>
              </div>
            </div>
          </div>
          
          ${result.matchedProduct ? `
          <!-- Product Info -->
          <div class="p-3 bg-zinc-800/50 rounded-lg">
            <p class="font-semibold text-white text-lg">${result.matchedProduct.team || 'Unknown Team'}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              <span class="px-2 py-1 text-xs bg-zinc-700 text-zinc-300 rounded">${result.matchedProduct.brand}</span>
              ${result.matchedProduct.season ? `<span class="px-2 py-1 text-xs bg-zinc-700 text-zinc-300 rounded">${result.matchedProduct.season}</span>` : ''}
              ${result.matchedProduct.kit_type ? `<span class="px-2 py-1 text-xs bg-zinc-700 text-zinc-300 rounded">${result.matchedProduct.kit_type}</span>` : ''}
              ${result.matchedProduct.variant ? `<span class="px-2 py-1 text-xs bg-zinc-700 text-zinc-300 rounded capitalize">${result.matchedProduct.variant}</span>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${result.blacklistMatch ? `
          <!-- Blacklist Warning -->
          <div class="p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
            <p class="font-semibold text-red-400">⚠️ Known Counterfeit Code</p>
            <p class="text-sm text-red-300/80 mt-1">${result.blacklistMatch.reason}</p>
            ${result.blacklistMatch.legitimate_use ? `
            <p class="text-xs text-zinc-400 mt-2 italic">Note: ${result.blacklistMatch.legitimate_use}</p>
            ` : ''}
          </div>
          ` : ''}
          
          <!-- Signals Breakdown -->
          <div class="pt-2">
            <p class="text-xs text-zinc-500 mb-2 flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              Evidence Breakdown
            </p>
            <div class="bg-zinc-800/30 rounded-lg p-3">
              ${renderSignals(result.signals)}
            </div>
          </div>
          
          <!-- Code Display -->
          <div class="flex items-center justify-between pt-2 border-t border-white/5">
            <code class="px-3 py-1.5 bg-zinc-800 rounded font-mono text-sm text-zinc-300">${code.trim().toUpperCase()}</code>
            <a href="/guides/${result.matchedProduct?.brand?.toLowerCase() || 'nike'}-authentication-guide" class="text-sm ${colors.text} hover:underline flex items-center gap-1">
              View ${result.matchedProduct?.brand || 'Brand'} Guide
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>
      `;
      resultContent.className = `p-4 rounded-xl border ${colors.border} ${colors.bg} ${colors.glow}`;
      
      // Refresh recently checked
      loadRecentlyChecked();
      
    } catch (error) {
      loadingState.classList.add('hidden');
      resultArea.classList.remove('hidden');
      checkBtn.disabled = false;
      
      resultContent.innerHTML = `
        <div class="flex items-center gap-3 text-red-400">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Error connecting to database. Please try again.</span>
        </div>
      `;
      resultContent.className = 'p-4 rounded-xl border border-red-500/20 bg-zinc-800/30';
    }
  }

  // ============================================
  // Recently Checked
  // ============================================

  async function loadRecentlyChecked() {
    const { data, error } = await supabase
      .from('product_codes')
      .select('*')
      .order('lookup_count', { ascending: false })
      .limit(5);
    
    if (error || !data || data.length === 0) return;
    
    if (recentlyChecked && recentCodes) {
      recentlyChecked.classList.remove('hidden');
      recentCodes.innerHTML = data.map(kit => `
        <button class="recent-kit px-2 py-1 text-xs bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded transition-colors" data-code="${kit.code}">
          ${kit.team || kit.brand} ${kit.season || ''}
        </button>
      `).join('');
      
      document.querySelectorAll('.recent-kit').forEach(btn => {
        btn.addEventListener('click', () => {
          const code = btn.getAttribute('data-code');
          if (code && input) {
            input.value = code;
            showResult(code);
          }
        });
      });
    }
  }

  // ============================================
  // Event Listeners
  // ============================================

  checkBtn?.addEventListener('click', () => {
    showResult(input?.value || '');
  });

  input?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      showResult(input.value);
    }
  });

  exampleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const code = btn.getAttribute('data-code');
      if (input && code) {
        input.value = code;
        showResult(code);
      }
    });
  });

  // Load recently checked on page load
  loadRecentlyChecked();
</script>
