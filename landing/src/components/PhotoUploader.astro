---
/**
 * PhotoUploader Component
 * 
 * Drag-and-drop photo upload with OCR extraction and verification.
 * Designed for 4-image authentication flow (front, back, label, detail).
 */

interface Props {
  maxImages?: number;
}

const { maxImages = 4 } = Astro.props;
---

<div class="photo-uploader p-6 bg-gradient-to-br from-zinc-900 to-zinc-900/50 rounded-2xl border border-white/10">
  <!-- Header -->
  <div class="flex items-center gap-3 mb-6">
    <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center">
      <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </div>
    <div>
      <h3 class="font-semibold text-white text-lg">Photo Authentication</h3>
      <p class="text-sm text-zinc-500">Upload photos to extract and verify product codes</p>
    </div>
  </div>

  <!-- Upload Zone -->
  <div 
    id="drop-zone"
    class="relative border-2 border-dashed border-white/20 rounded-xl p-8 text-center cursor-pointer transition-all hover:border-purple-500/50 hover:bg-purple-500/5"
  >
    <input 
      type="file" 
      id="file-input"
      accept="image/*"
      multiple
      class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
    />
    
    <div id="upload-prompt" class="space-y-3">
      <div class="w-16 h-16 mx-auto rounded-full bg-zinc-800 flex items-center justify-center">
        <svg class="w-8 h-8 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </div>
      <div>
        <p class="text-zinc-300 font-medium">Drop your photos here</p>
        <p class="text-sm text-zinc-500">or click to browse ‚Ä¢ Max {maxImages} images</p>
      </div>
      <div class="flex flex-wrap justify-center gap-2 pt-2">
        <span class="px-2 py-1 text-xs bg-zinc-800 text-zinc-400 rounded">üì∑ Label Close-up</span>
        <span class="px-2 py-1 text-xs bg-zinc-800 text-zinc-400 rounded">üè∑Ô∏è Wash Tag</span>
        <span class="px-2 py-1 text-xs bg-zinc-800 text-zinc-400 rounded">üëï Front</span>
        <span class="px-2 py-1 text-xs bg-zinc-800 text-zinc-400 rounded">üîô Back</span>
      </div>
    </div>
  </div>

  <!-- Image Previews -->
  <div id="image-previews" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
  </div>

  <!-- OCR Progress -->
  <div id="ocr-progress" class="hidden mt-4 p-4 bg-zinc-800/50 rounded-lg">
    <div class="flex items-center gap-3">
      <svg class="animate-spin w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <div class="flex-1">
        <p class="text-sm text-zinc-300">Extracting product codes...</p>
        <div class="mt-1 h-1.5 bg-zinc-700 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-purple-500 transition-all" style="width: 0%"></div>
        </div>
      </div>
      <span id="progress-text" class="text-sm text-zinc-500">0%</span>
    </div>
  </div>

  <!-- Extracted Codes -->
  <div id="extracted-codes" class="hidden mt-4 space-y-3">
    <p class="text-sm text-zinc-400 flex items-center gap-2">
      <svg class="w-4 h-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      Extracted Codes
    </p>
    <div id="codes-list" class="space-y-2"></div>
  </div>

  <!-- Verify Button -->
  <div id="verify-section" class="hidden mt-4">
    <button 
      id="verify-btn"
      class="w-full py-3 px-4 bg-purple-500 hover:bg-purple-400 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
      </svg>
      Verify All Codes
    </button>
  </div>

  <!-- Verification Results -->
  <div id="verification-results" class="hidden mt-4 space-y-3">
  </div>
</div>

<script>
  import { preprocessForOCR } from '../lib/ocr';
  import Tesseract from 'tesseract.js';
  import { createClient } from '@supabase/supabase-js';

  // ============================================
  // Initialize
  // ============================================
  
  const supabaseUrl = 'https://sjltydrpwavzrrmoaivt.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqbHR5ZHJwd2F2enJybW9haXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NDQwMzEsImV4cCI6MjA4NDIyMDAzMX0.nPdmhcj3GsvQ8xtE4i2CMptWb9kxMy1NKYyI1M7oT9k';
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  console.log('[PhotoUploader] Script loaded');
  
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhotoUploader);
  } else {
    initPhotoUploader();
  }

  function initPhotoUploader() {
    console.log('[PhotoUploader] Initializing...');

    // DOM Elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input') as HTMLInputElement;
    const uploadPrompt = document.getElementById('upload-prompt');
    const imagePreviews = document.getElementById('image-previews');
    const ocrProgress = document.getElementById('ocr-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const extractedCodes = document.getElementById('extracted-codes');
    const codesList = document.getElementById('codes-list');
    const verifySection = document.getElementById('verify-section');
    const verifyBtn = document.getElementById('verify-btn');
    const verificationResults = document.getElementById('verification-results');

    if (!dropZone || !fileInput) {
      console.error('[PhotoUploader] Required elements not found');
      return;
    }
    
    console.log('[PhotoUploader] DOM elements found');

    // State
    let uploadedFiles: File[] = [];
    let detectedCodes: { code: string; brand: string; imageIndex: number }[] = [];
    const MAX_IMAGES = 4;

  // ============================================
  // Code Patterns
  // ============================================

  const CODE_PATTERNS: Record<string, RegExp[]> = {
    Nike: [/[A-Z]{2}\d{4}-\d{3}/g, /\d{6}-\d{3}/g],
    Adidas: [/[A-Z]{2}\d{4}/g, /[A-Z]\d{5}/g],
    Puma: [/\d{6}-\d{2}/g],
    Umbro: [/\d{5}-U/gi],
  };

  function extractCodesFromText(text: string): { code: string; brand: string }[] {
    const codes: { code: string; brand: string }[] = [];
    const seen = new Set<string>();
    
    const normalizedText = text.toUpperCase().replace(/[Oo]/g, '0').replace(/[Il]/g, '1');
    
    for (const [brand, patterns] of Object.entries(CODE_PATTERNS)) {
      for (const pattern of patterns) {
        pattern.lastIndex = 0;
        const matches = normalizedText.matchAll(pattern);
        for (const match of matches) {
          const code = match[0].toUpperCase();
          if (!seen.has(code)) {
            seen.add(code);
            codes.push({ code, brand });
          }
        }
      }
    }
    
    return codes;
  }

  // ============================================
  // File Handling
  // ============================================

  function handleFiles(files: FileList | File[]) {
    const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
    
    if (uploadedFiles.length + imageFiles.length > MAX_IMAGES) {
      alert(`Maximum ${MAX_IMAGES} images allowed`);
      return;
    }
    
    uploadedFiles = [...uploadedFiles, ...imageFiles];
    renderPreviews();
    
    if (uploadedFiles.length > 0) {
      processImages();
    }
  }

  function renderPreviews() {
    if (!imagePreviews) return;
    
    if (uploadedFiles.length === 0) {
      imagePreviews.classList.add('hidden');
      return;
    }
    
    imagePreviews.classList.remove('hidden');
    imagePreviews.innerHTML = uploadedFiles.map((file, index) => `
      <div class="relative group aspect-square rounded-lg overflow-hidden bg-zinc-800">
        <img 
          src="${URL.createObjectURL(file)}" 
          alt="Upload ${index + 1}"
          class="w-full h-full object-cover"
        />
        <button 
          class="remove-btn absolute top-1 right-1 w-6 h-6 bg-red-500/80 hover:bg-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
          data-index="${index}"
        >
          <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/70 to-transparent p-2">
          <span class="text-xs text-white/80">${index + 1}/${MAX_IMAGES}</span>
        </div>
      </div>
    `).join('');
    
    // Add remove handlers
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt((btn as HTMLElement).dataset.index || '0');
        uploadedFiles.splice(index, 1);
        detectedCodes = detectedCodes.filter(c => c.imageIndex !== index);
        renderPreviews();
        renderExtractedCodes();
      });
    });
  }

  // ============================================
  // OCR Processing
  // ============================================

  async function processImages() {
    if (!ocrProgress || !progressBar || !progressText) return;
    
    ocrProgress.classList.remove('hidden');
    detectedCodes = [];
    
    for (let i = 0; i < uploadedFiles.length; i++) {
      const file = uploadedFiles[i];
      
      try {
        // Preprocess image for better OCR accuracy
        const processedImage = await preprocessForOCR(file);
        
        const { data } = await Tesseract.recognize(
          processedImage,
          'eng',
          {
            logger: (m) => {
              if (m.status === 'recognizing text') {
                const totalProgress = ((i + m.progress) / uploadedFiles.length) * 100;
                progressBar.style.width = `${totalProgress}%`;
                progressText.textContent = `${Math.round(totalProgress)}%`;
              }
            },
          }
        );
        
        const codes = extractCodesFromText(data.text);
        codes.forEach(c => detectedCodes.push({ ...c, imageIndex: i }));
        
        // Clean up processed image URL
        if (processedImage.startsWith('data:') || processedImage.startsWith('blob:')) {
          // Data URLs don't need cleanup, but blob URLs do
          if (processedImage.startsWith('blob:')) {
            URL.revokeObjectURL(processedImage);
          }
        }
        
      } catch (error) {
        console.error('OCR error:', error);
      }
    }
    
    ocrProgress.classList.add('hidden');
    renderExtractedCodes();
  }

  function renderExtractedCodes() {
    if (!extractedCodes || !codesList || !verifySection) return;
    
    if (detectedCodes.length === 0) {
      extractedCodes.classList.add('hidden');
      verifySection.classList.add('hidden');
      return;
    }
    
    extractedCodes.classList.remove('hidden');
    verifySection.classList.remove('hidden');
    
    codesList.innerHTML = detectedCodes.map((item, index) => `
      <div class="flex items-center justify-between p-3 bg-zinc-800/50 rounded-lg">
        <div class="flex items-center gap-3">
          <span class="w-6 h-6 rounded-full bg-purple-500/20 text-purple-400 text-xs flex items-center justify-center">${index + 1}</span>
          <code class="font-mono text-zinc-200">${item.code}</code>
        </div>
        <span class="px-2 py-1 text-xs rounded ${getBrandClass(item.brand)}">${item.brand}</span>
      </div>
    `).join('');
  }

  function getBrandClass(brand: string): string {
    const classes: Record<string, string> = {
      Nike: 'bg-orange-500/20 text-orange-400',
      Adidas: 'bg-blue-500/20 text-blue-400',
      Puma: 'bg-green-500/20 text-green-400',
      Umbro: 'bg-purple-500/20 text-purple-400',
    };
    return classes[brand] || 'bg-zinc-700 text-zinc-400';
  }

  // ============================================
  // Verification
  // ============================================

  async function verifyAllCodes() {
    if (!verificationResults) return;
    
    verificationResults.classList.remove('hidden');
    verificationResults.innerHTML = '<div class="text-center text-zinc-500 py-4">Verifying codes...</div>';
    
    const results: string[] = [];
    
    for (const item of detectedCodes) {
      // Check blacklist
      const { data: blacklistData } = await supabase
        .from('blacklist_codes')
        .select('*')
        .ilike('code', item.code)
        .single();
      
      // Check product codes
      const { data: productData } = await supabase
        .from('product_codes')
        .select('*')
        .ilike('code', item.code)
        .single();
      
      if (blacklistData) {
        results.push(`
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-red-500 text-lg">‚õî</span>
              <code class="font-mono text-red-400">${item.code}</code>
              <span class="px-2 py-0.5 text-xs bg-red-500/20 text-red-400 rounded">BLACKLISTED</span>
            </div>
            <p class="text-sm text-red-300/80 mt-2">${blacklistData.reason}</p>
          </div>
        `);
      } else if (productData) {
        results.push(`
          <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-emerald-400 text-lg">‚úì</span>
              <code class="font-mono text-emerald-400">${item.code}</code>
              <span class="px-2 py-0.5 text-xs bg-emerald-500/20 text-emerald-400 rounded">VERIFIED</span>
            </div>
            <p class="text-sm text-zinc-300 mt-2">${productData.brand} ${productData.team} ${productData.season}</p>
          </div>
        `);
      } else {
        results.push(`
          <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-yellow-400 text-lg">?</span>
              <code class="font-mono text-yellow-400">${item.code}</code>
              <span class="px-2 py-0.5 text-xs bg-yellow-500/20 text-yellow-400 rounded">UNKNOWN</span>
            </div>
            <p class="text-sm text-zinc-400 mt-2">Code not found in our database</p>
          </div>
        `);
      }
    }
    
    verificationResults.innerHTML = results.join('');
  }

  // ============================================
  // Event Listeners
  // ============================================

  console.log('[PhotoUploader] Attaching event listeners...');

  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-purple-500', 'bg-purple-500/10');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-purple-500', 'bg-purple-500/10');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    console.log('[PhotoUploader] Files dropped');
    dropZone.classList.remove('border-purple-500', 'bg-purple-500/10');
    if (e.dataTransfer?.files) {
      handleFiles(e.dataTransfer.files);
    }
  });

  // File input
  fileInput.addEventListener('change', () => {
    console.log('[PhotoUploader] Files selected via input');
    if (fileInput.files) {
      handleFiles(fileInput.files);
    }
  });

  // Verify button
  verifyBtn?.addEventListener('click', verifyAllCodes);
  
  console.log('[PhotoUploader] Ready');
  
  } // Close initPhotoUploader function
</script>

